# Pull Request: Add Daily Impressions and Surveys System

**Base branch:** `claude/fix-notification-issues-011CULzQ94VCx9oXGQKLmY6G`
**Head branch:** `claude/add-daily-impressions-011CUSL64MoitMh3hjzWoUyS`

---

## Summary

–î–æ–±–∞–≤–ª–µ–Ω—ã –¥–≤–µ –Ω–æ–≤—ã–µ –æ—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –±–æ—Ç–∞ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è:
- üÜï **–ë—ã—Å—Ç—Ä—ã–µ –≤–ø–µ—á–∞—Ç–ª–µ–Ω–∏—è (Impressions)** - –º–æ–º–µ–Ω—Ç–∞–ª—å–Ω–∞—è —Ñ–∏–∫—Å–∞—Ü–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏–π —Å –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º–∏ –∏ —Ç–µ–≥–∞–º–∏
- üÜï **–°–∏—Å—Ç–µ–º–∞ –æ–ø—Ä–æ—Å–æ–≤ (Surveys)** - —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —à–∞–±–ª–æ–Ω—ã –æ–ø—Ä–æ—Å–æ–≤ —Å –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π –∏ —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ–º

## Phase 1: Impressions (59 tests)

### –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:
- **Database Migration** (Phase 1.1): –°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü `impressions` –∏ `impression_tags` —Å CASCADE DELETE
- **Data Models** (Phase 1.2): `Impression` –∏ `ImpressionTag` dataclasses —Å –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π
- **Storage Layer** (Phase 1.3): CRUD –æ–ø–µ—Ä–∞—Ü–∏–∏ —Å —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ–º –¥–∞–Ω–Ω—ã—Ö
- **Handler** (Phase 1.4): Conversation flow –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤–ø–µ—á–∞—Ç–ª–µ–Ω–∏–π
- **Viewing** (Phase 1.5): –ö–æ–º–∞–Ω–¥—ã `/impressions` –∏ `/impressions_history` —Å —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–µ–π

### –ö–ª—é—á–µ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:
- 5 –∫–∞—Ç–µ–≥–æ—Ä–∏–π: craving, emotion, physical, thoughts, other
- –ò–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç—å –æ—Ç 1 –¥–æ 10
- –ì–∏–±–∫–∞—è —Å–∏—Å—Ç–µ–º–∞ —Ç–µ–≥–æ–≤ (—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ –∑–∞–ø—è—Ç—ã–º–∏)
- –®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ –≤–ø–µ—á–∞—Ç–ª–µ–Ω–∏–π
- –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º, –¥–∞—Ç–∞–º, —Ç–µ–≥–∞–º

## Phase 2: Surveys (65 tests)

### –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:
- **Database Migration** (Phase 2.1): –¢–∞–±–ª–∏—Ü—ã –¥–ª—è —à–∞–±–ª–æ–Ω–æ–≤, –≤–æ–ø—Ä–æ—Å–æ–≤ –∏ –æ—Ç–≤–µ—Ç–æ–≤
- **Data Models** (Phase 2.2): `SurveyTemplate`, `SurveyQuestion`, `SurveyResponse`
- **System Templates** (Phase 2.3): 4 –≥–æ—Ç–æ–≤—ã—Ö —à–∞–±–ª–æ–Ω–∞ –æ–ø—Ä–æ—Å–æ–≤:
  - üß† –ö–ü–¢ –¥–Ω–µ–≤–Ω–∏–∫ (7 –≤–æ–ø—Ä–æ—Å–æ–≤)
  - üí™ –î–Ω–µ–≤–Ω–∏–∫ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ (7 –≤–æ–ø—Ä–æ—Å–æ–≤)
  - üôè –î–Ω–µ–≤–Ω–∏–∫ –±–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç–∏ (3 –≤–æ–ø—Ä–æ—Å–∞)
  - üò¥ –î–Ω–µ–≤–Ω–∏–∫ —Å–Ω–∞ (6 –≤–æ–ø—Ä–æ—Å–æ–≤)
- **Storage Layer** (Phase 2.4): CRUD –æ–ø–µ—Ä–∞—Ü–∏–∏ —Å —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ–º –æ—Ç–≤–µ—Ç–æ–≤
- **Fill Handlers** (Phase 2.5): –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ —Å –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π 6 —Ç–∏–ø–æ–≤ –≤–æ–ø—Ä–æ—Å–æ–≤
- **Viewing Handlers** (Phase 2.6): –ü—Ä–æ—Å–º–æ—Ç—Ä –æ—Ç–≤–µ—Ç–æ–≤ —Å –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–æ–π –∏ –ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π

### –¢–∏–ø—ã –≤–æ–ø—Ä–æ—Å–æ–≤:
- `text`: —Å–≤–æ–±–æ–¥–Ω—ã–π —Ç–µ–∫—Å—Ç
- `numeric`: —á–∏—Å–ª–∞ —Å –¥–∏–∞–ø–∞–∑–æ–Ω–æ–º
- `yes_no`: –¥–∞/–Ω–µ—Ç
- `time`: –≤—Ä–µ–º—è –≤ —Ñ–æ—Ä–º–∞—Ç–µ HH:MM
- `choice`: –≤—ã–±–æ—Ä (–æ–¥–∏–Ω–æ—á–Ω—ã–π/–º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–π)
- `scale`: —à–∫–∞–ª–∞ –æ—Ü–µ–Ω–∫–∏

### –í–∞–ª–∏–¥–∞—Ü–∏—è:
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∏–ø–æ–≤ –¥–∞–Ω–Ω—ã—Ö
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∏–∞–ø–∞–∑–æ–Ω–æ–≤ –¥–ª—è numeric –∏ scale
- Regex –≤–∞–ª–∏–¥–∞—Ü–∏—è –¥–ª—è –≤—Ä–µ–º–µ–Ω–∏
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ–ø—É—Å—Ç–∏–º—ã—Ö –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –¥–ª—è choice

## Integration & Automation

### Bot Integration:
- –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –≤—Å–µ—Ö –Ω–æ–≤—ã—Ö handlers –≤ `src/bot.py`
- –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è `SURVEY_ANSWER` –≤ config
- –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ `src/handlers/__init__.py`

### Database Migrations:
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∑–∞–ø—É—Å–∫ –º–∏–≥—Ä–∞—Ü–∏–π –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –ë–î
- –ó–∞–≥—Ä—É–∑–∫–∞ —Å–∏—Å—Ç–µ–º–Ω—ã—Ö —à–∞–±–ª–æ–Ω–æ–≤ –æ–ø—Ä–æ—Å–æ–≤ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—É—Å–∫–µ
- –ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω—ã–µ –º–∏–≥—Ä–∞—Ü–∏–∏ (–±–µ–∑–æ–ø–∞—Å–Ω–æ–µ –ø–æ–≤—Ç–æ—Ä–Ω–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ)

### Documentation:
- –û–±–Ω–æ–≤–ª–µ–Ω README —Å –ø–æ–¥—Ä–æ–±–Ω—ã–º –æ–ø–∏—Å–∞–Ω–∏–µ–º –Ω–æ–≤—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π
- –ö–∞—Ç–µ–≥–æ—Ä–∏–∑–∏—Ä–æ–≤–∞–Ω—ã –∫–æ–º–∞–Ω–¥—ã –±–æ—Ç–∞
- –û–±–Ω–æ–≤–ª–µ–Ω–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞
- –û–ø–∏—Å–∞–Ω—ã —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ –≥–∏–±—Ä–∏–¥–Ω–æ–≥–æ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞

## Test Coverage

‚úÖ **344 —Ç–µ—Å—Ç–æ–≤ —É—Å–ø–µ—à–Ω–æ –ø—Ä–æ—Ö–æ–¥—è—Ç**
- 59 —Ç–µ—Å—Ç–æ–≤ –¥–ª—è Impressions
- 65 —Ç–µ—Å—Ç–æ–≤ –¥–ª—è Surveys
- 220 —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —Ç–µ—Å—Ç–æ–≤

### –ú–µ—Ç–æ–¥–æ–ª–æ–≥–∏—è:
- –°—Ç—Ä–æ–≥–∏–π TDD –ø–æ–¥—Ö–æ–¥ (Test-Driven Development)
- pytest —Å AsyncMock –¥–ª—è async handlers
- –§–∏–∫—Å—Ç—É—Ä—ã –¥–ª—è –∏–∑–æ–ª—è—Ü–∏–∏ —Ç–µ—Å—Ç–æ–≤
- –ü—Ä–æ–≤–µ—Ä–∫–∞ edge cases –∏ error handling

## Technical Stack

- **Database**: SQLite —Å foreign keys –∏ CASCADE DELETE
- **Encryption**: Fernet/AES –¥–ª—è —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö
- **Framework**: python-telegram-bot —Å ConversationHandler
- **Testing**: pytest, pytest-asyncio, unittest.mock
- **Migrations**: Idempotent SQL migrations

## Files Changed

### New Files:
**Data Layer:**
- `src/data/impressions_storage.py` - —Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤–ø–µ—á–∞—Ç–ª–µ–Ω–∏–π
- `src/data/surveys_storage.py` - —Ö—Ä–∞–Ω–µ–Ω–∏–µ –æ–ø—Ä–æ—Å–æ–≤ –∏ –æ—Ç–≤–µ—Ç–æ–≤
- `src/data/system_surveys.py` - —Å–∏—Å—Ç–µ–º–Ω—ã–µ —à–∞–±–ª–æ–Ω—ã
- `src/data/migrations/add_impressions_tables.py`
- `src/data/migrations/add_surveys_tables.py`

**Handlers:**
- `src/handlers/impression_handler.py` - –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤–ø–µ—á–∞—Ç–ª–µ–Ω–∏–π
- `src/handlers/impression_viewing.py` - –ø—Ä–æ—Å–º–æ—Ç—Ä –≤–ø–µ—á–∞—Ç–ª–µ–Ω–∏–π
- `src/handlers/survey_handlers.py` - –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –æ–ø—Ä–æ—Å–æ–≤
- `src/handlers/survey_viewing.py` - –ø—Ä–æ—Å–º–æ—Ç—Ä –æ—Ç–≤–µ—Ç–æ–≤

**Tests:**
- `tests/test_impressions_*.py` (5 —Ñ–∞–π–ª–æ–≤, 59 —Ç–µ—Å—Ç–æ–≤)
- `tests/test_surveys_*.py` (7 —Ñ–∞–π–ª–æ–≤, 65 —Ç–µ—Å—Ç–æ–≤)

### Modified Files:
- `src/config.py` - –¥–æ–±–∞–≤–ª–µ–Ω SURVEY_ANSWER state
- `src/bot.py` - —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –Ω–æ–≤—ã—Ö handlers
- `src/handlers/__init__.py` - —ç–∫—Å–ø–æ—Ä—Ç –Ω–æ–≤—ã—Ö handlers
- `src/data/storage.py` - –∞–≤—Ç–æ–∑–∞–ø—É—Å–∫ –º–∏–≥—Ä–∞—Ü–∏–π
- `src/data/models.py` - –¥–æ–±–∞–≤–ª–µ–Ω—ã –Ω–æ–≤—ã–µ dataclasses
- `README.md` - –æ–±–Ω–æ–≤–ª–µ–Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

## Commands Added

### Impressions:
- `/impression` - –¥–æ–±–∞–≤–∏—Ç—å –±—ã—Å—Ç—Ä–æ–µ –≤–ø–µ—á–∞—Ç–ª–µ–Ω–∏–µ
- `/impressions` - –ø—Ä–æ—Å–º–æ—Ç—Ä –≤–ø–µ—á–∞—Ç–ª–µ–Ω–∏–π –∑–∞ —Å–µ–≥–æ–¥–Ω—è
- `/impressions_history` - –∏—Å—Ç–æ—Ä–∏—è –≤—Å–µ—Ö –≤–ø–µ—á–∞—Ç–ª–µ–Ω–∏–π

### Surveys:
- `/surveys` - —Å–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –æ–ø—Ä–æ—Å–æ–≤
- `/fill <–Ω–∞–∑–≤–∞–Ω–∏–µ>` - –∑–∞–ø–æ–ª–Ω–∏—Ç—å –æ–ø—Ä–æ—Å
- `/my_responses` - –≤—Å–µ –º–æ–∏ –æ—Ç–≤–µ—Ç—ã –Ω–∞ –æ–ø—Ä–æ—Å—ã
- `/survey_responses <–Ω–∞–∑–≤–∞–Ω–∏–µ>` - –æ—Ç–≤–µ—Ç—ã –Ω–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –æ–ø—Ä–æ—Å

## Breaking Changes

–ù–µ—Ç breaking changes - –≤—Å–µ –Ω–æ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–æ–±–∞–≤–ª–µ–Ω—ã –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ API.

## Next Steps

–ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è (–Ω–µ –≤—Ö–æ–¥—è—Ç –≤ —Ç–µ–∫—É—â–∏–π PR):
- Phase 3: –ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö –æ–ø—Ä–æ—Å–æ–≤
- –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –≤–ø–µ—á–∞—Ç–ª–µ–Ω–∏–π –∏ –æ—Ç–≤–µ—Ç–æ–≤ –Ω–∞ –æ–ø—Ä–æ—Å—ã
- –ú–∏–≥—Ä–∞—Ü–∏—è –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –¥–Ω–µ–≤–Ω–∏–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è –≤ SQLite

---

ü§ñ Generated with [Claude Code](https://claude.com/claude-code)
